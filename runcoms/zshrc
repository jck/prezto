#
# Executes commands at the start of an interactive session.
#
# Authors:
#   Sorin Ionescu <sorin.ionescu@gmail.com>
#

# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# Customize to your needs...
stty -ixon

# Rehash everytime, to take care of newly installed applications
zstyle ':completion:*' rehash true

# Add my scripts to the path
path+=~/bin

# My aliases
for file in ~/.zalias/*; do
  source $file
done


function autoenv_enable {
}

function autoenv_disable {
    chpwd_functions=(${chpwd_functions#autoenv})
}

function autoenv {
    if (( ($+VIRTUAL_ENV)  && !($+AUTOENV) )); then
        return
    fi

    if ! is-true "$(git rev-parse --is-inside-work-tree 2> /dev/null)"; then
        if (($+VIRTUAL_ENV)); then
            chpwd_functions=(${chpwd_functions#autoenv})
            deactivate && unset AUTOENV
            chpwd_functions+=(autoenv)
        fi
        return
    fi

    local root="$(git rev-parse --show-toplevel 2> /dev/null)"
    if [ -f "$root/.venv" ]; then
        local name=$(<$root/.venv)
    else
        local name=$root:t
    fi

    if [[ -d "$WORKON_HOME/$name" ]] && [[ "$VIRTUAL_ENV:t" != $name ]]; then
        chpwd_functions=(${chpwd_functions#autoenv})
        workon $name
        chpwd_functions+=(autoenv)
        export AUTOENV=1
    fi
}

typeset -U chpwd_functions
chpwd_functions+=(autoenv)
